<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Admin</title>
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
		<style>
		table {
			width: 100%;
		}
		textarea {
			width: 300px;
			height: 100px;
		}
		</style>
	</head>
	<body>
		<ul class="list-group">
			<li class="list-group-item">First item</li>
			<li class="list-group-item">Second item</li>
			<li class="list-group-item">Third item</li>
		</ul>
		<div class="list-group">
			<a href="#" class="list-group-item">First item</a>
			<a href="#" class="list-group-item">Second item</a>
			<a href="#" class="list-group-item">Third item</a>
		</div>
		<div id="content"></div>
		<script src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<script>
		$(function() {
			var PlanValue = [{
				name: "Value",
				type: "text"
			}, {
				name: "Unit",
				type: "text"
			}];

			var Plan = [{
				name: "Condition",
				type: "text"
			}, {
				name: "DateItemId",
				type: "text"
			}, {
				name: "DateValue",
				type: "text"
			}, {
				name: "DatePosition",
				type: "text"
			}, {
				name: "Delay",
				type: PlanValue
			}, {
				name: "ValueFrom",
				type: PlanValue
			}, {
				name: "ValueTo",
				type: PlanValue
			}, {
				name: "Interval",
				type: PlanValue
			}, {
				name: "ValueAt",
				type: [PlanValue]
			}];

			var Code = [{
				name: "Name",
				type: "text"
			}, {
				name: "Value",
				type: "text"
			}, {
				name: "Extra",
				type: "json"
			}];

			var Item = [{
				name: "Name",
				type: "text"
			}, {
				name: "Type",
				type: "text"
			}, {
				name: "TypeArgv",
				type: "text"
			}, {
				name: "Extra",
				type: "json"
			}, {
				name: "Codes",
				type: [Code]
			}];

			var Group = [{
				name: "Name",
				type: "text"
			}, {
				name: "Type",
				type: "text"
			}, {
				name: "Extra",
				type: "json"
			}, {
				name: "Items",
				type: [Item]
			}];

			var form = [{
				name: "Name",
				type: "text"
			}, {
				name: "Plan",
				type: Plan
			}, {
				name: "Groups",
				type: [Group]
			}];

			var Study = [{
				name: "Name",
				type: "text"
			}, {
				name: "Forms",
				type: [form]
			}];

			BuildTable($("#content"), name, Study);

			function BuildTable(jCont, name, meta, isList) {
				var jTable = $('<table name="' + name + '" class="table-bordered"><tbody></tbody></table>').appendTo(jCont);

				var jTrFirst = null;
				for(var i=0; i<meta.length; ++i) {
					var item = meta[i];

					var jTr = $('<tr></tr>').appendTo(jTable);
					if(jTrFirst == null) {
						jTrFirst = jTr;
					}
					var jNameTd = $('<th></th>').appendTo(jTr);
					jNameTd.css("width", "100px");
					jNameTd.css("min-width", "100px");
					jNameTd.css("max-width", "100px");
					jNameTd.text(item.name);

					var jInputTd = $('<td colspan="2"></td>').appendTo(jTr);
					switch(item.type) {
					case "text":
						$('<input type="text" name="' + item.name + '" />').appendTo(jInputTd);
						break;
					case "json":
						$('<textarea name="' + item.name + '"/>').appendTo(jInputTd);
						break;
					default:
						if($.isArray(item.type)) {
							if($.isArray(item.type[0])) {
								var jBtnAdd = $('<div class="btn btn-info">+</div>').appendTo(jNameTd);
								jBtnAdd.click(function() {
									var jClone = $(this).data("table").clone(true, true);
									$(this).parent().next().append(jClone);
								});
								
								jInputTd.attr("colspan", null);
								BuildTable(jInputTd, item.name, item.type[0], true);
								jBtnAdd.data("table", jInputTd.children().filter("table").detach());
							} else {
								BuildTable(jInputTd, item.name, item.type, false);
							}
						} else {
							console.error(name, meta, item);
						}
						break;
					}
				}

				if(isList) {
					var jRemoveTd = $('<td></td>').insertBefore(jTrFirst.find("td").eq(0));
					jRemoveTd.attr("rowspan", meta.length);
					jRemoveTd.append($('<div class="btn btn-danger">X</div>'));
					jRemoveTd.css("width", "38px");
					jRemoveTd.click(function() {
						var jParent = $(this).parent();
						while(jParent.get(0).tagName.toLowerCase() != "table") {
							jParent = jParent.parent();
						}
						jParent.detach();
					});
				}
			}
		});
		</script>
	</body>
</html>
