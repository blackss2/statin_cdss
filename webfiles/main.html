<% template "top.html" . %>

<div id="container" style="margin-left:0px;" class="clearfix" v-root-container>
	<% template "header.html" . %>
	<div class="content-wrapper clearfix">
		<div class="content clearfix">
			<div class="col-sm-4">
				<section class="box">
					<h3 class="title">전체 이상반응2</h3>
					<div class="content">
						<canvas id="chart-area" style="width:250px; height:100px;"/>
					</div>
				</section>
			</div>
			<div class="col-sm-4">
				<section class="box">
					<h3 class="title">군별 이상반응</h3>
					<div class="content">
						<canvas id="chart-area2" style="width:250px; height:100px;"/>
					</div>
				</section>
			</div>
			<div class="col-sm-4">
				<compliance>
					<section class="box">
						<h3 class="title">의무기록 전체 순응도</h3>
						<div class="content">
							<table class="table-default table-pagination">
								<thead>
									<th>일</th>
									<th>국소</th>
									<th>전신</th>
									<th>생체</th>
									<th>순응도</th>
								</thead>
								<tbody>
									<tr v-for="item in constants.compliances">
										<td>{{item.day}}일</td>
										<td>{{item.local}}%</td>
										<td>{{item.sysmetic}}%</td>
										<td>{{item.vital}}%</td>
										<td>{{item.total}}%</td>
									</tr>
								</tbody>
							</table>
						</div>
					</section>
					<script type="vue">
					data: function() {
						var obj = {
							constants: {
								compliances: Store.get("page-initial").compliances,
							}
						};
						return obj;
					},
					methods: {
					}
					</script>
				</compliance>
			</div>
		</div>
		<div class="content clearfix">
			<div class="col-sm-8">
				<section class="box">
					<h3 class="title">전체 피험자 Enroll 그래프</h3>
					<div class="content">
						<canvas id="bar-chart" style="width:500px; height:100px;"/>
					</div>
				</section>
			</div>
			<div class="col-sm-4">
				<section class="box">
					<h3 class="title">
						예약
						<span class="right update"> UPDATE : 2016.04.19 </span>
					</h3>
					<div class="content">
						<table class="table-default table-height-full">
							<thead>
								<th>대상군</th>
								<th>예약 인원</th>
							</thead>
							<tbody>
								<tr>
									<td>전체</td>
									<td>12명</td>
								</tr>
								<tr>
									<td>실험군</td>
									<td>5명</td>
								</tr>
								<tr>
									<td>대조군</td>
									<td>4명</td>
								</tr>
								<tr>
									<td>위약군</td>
									<td>3명</td>
								</tr>
							</tbody>
						</table>
					</div>
				</section>
			</div>
		</div>
		<div class="content clearfix">
			<div class="col-sm-12">
				<notices>
					<section class="box">
						<h3 class="title">공지사항</h3>
						<div class="content notice clearfix">
							<div class="col-xs-7">
								<textarea v-model="input.content"></textarea>
								<div class="btn-grp">
									<button type="button" class="btn btn-sm btn-aqua" v-on:click="saveNotice">공지사항 내용 등록</button>
									<div class="right">
									<button type="button" class="btn btn-sm btn-dark" v-on:click="sendNotice">전송</button>
									</div>
								</div>
							</div>
							<div class="col-xs-1">
								<div class="icon-left">
									<i class="fa fa-caret-left"></i>
								</div>
							</div>
							<div class="col-xs-4">
								<table class="table-default table-pagination">
									<thead>
										<tr>
											<th>자주 사용하는 공지사항</th>
											<th>삭제</th>
										</tr>
									</thead>
									<tbody>
										<tr v-for="item in constants.notices">
											<td v-on:click="readNotice(item)" style="cursor:pointer;">{{item.content}}</td>
											<td><button type="button" class="btn btn-sm btn-danger" v-on:click="deleteNotice(item)">삭제</button></td>
										</tr>
									</tbody>
									<tfoot>
										<tr>
											<td colspan='2'>
												<div class="pagination">
													<button type="button" class="btn btn-sm btn-prev" v-on:click="loadPage(start_page-1)">&lt;</button>
													<button type="button" class="btn btn-sm" v-for="page in pages" v-bind:class="{active: (page==current_page)}" v-on:click="loadPage(page)">{{page}}</button>
													<button type="button" class="btn btn-sm btn-next" v-on:click="loadPage(end_page+1)">&gt;</button>
												</div>
											</td>
										</tr>
									</tfoot>
								</table>
							</div>
						</div>
					</section>
					<script type="vue">
					data: function() {
						var obj = {
							constants: {
								notices: Store.get("page-initial").notices,
								count: Store.get("page-initial").notice_count,
							},
							input: {
								content: ""
							},
							offset: 0,
							limit: 15,
							current_page: 1
						};
						return obj;
					},
					computed: {
						max_page: function() {
							if(this.constants.count == 0) {
								return 1;
							} else {
								return Math.floor((this.constants.count - 1)/this.limit) + 1;
							}
						},
						start_page: function() {
							return Math.floor((this.current_page - 1)/5)*5 + 1;
						},
						end_page: function() {
							return Math.min(this.max_page, Math.floor((this.current_page - 1)/5)*5 + 5);
						},
						pages: function() {
							var pages = [];
							for(var i=this.start_page; i<=this.end_page; i++) {
								pages.push(i);
							}
							return pages;
						}
					},
					methods: {
						readNotice: function(item) {
							this.input.content = item.content;
						},
						loadPage: function(page) {
							if(page < 1) {
								page = 1;
							} else if(page > this.max_page) {
								page = this.max_page;
							}
							this.current_page = page;
							this.offset = this.limit*(page - 1);
							this.$http.get("/api/notices?offset=" + this.offset + "&limit=" + this.limit).then(function(res) {
								if(res.body.error != null) {
									alert(res.body.error);
								} else {
									this.constants.notices = res.body.result.notices;
									this.constants.count = res.body.result.notice_count;
								}
							}, function(err) {
								console.error(err.body);
							});
						},
						saveNotice: function() {
							if(this.input.content.length == 0) {
								alert("공지사항 내용을 입력해주세요");
								return;
							}
							this.$http.post("/api/notices", {
								content: this.input.content
							}).then(function(res) {
								if(res.body.error != null) {
									alert(res.body.error);
								} else {
									alert("등록되었습니다.");
									this.loadPage(this.current_page);
								}
							}, function(err) {
								console.error(err.body);
							});
						},
						sendNotice: function() {
							if(this.input.content.length == 0) {
								alert("공지사항 내용을 입력해주세요");
								return;
							}
							this.$http.post("/api/notice_push", {
								content: this.input.content
							}).then(function(res) {
								if(res.body.error != null) {
									alert(res.body.error);
								} else {
									alert("전송되었습니다,");
								}
							}, function(err) {
								console.error(err.body);
							});
						},
						deleteNotice: function(item) {
							if(window.confirm("정말 삭제하시겠습니까?")) {
								this.$http.delete("/api/notices/" + item.id).then(function(res) {
									if(res.body.error != null) {
										alert(res.body.error);
									} else {
										alert("삭제되었습니다,");
										this.loadPage(this.current_page);
									}
								}, function(err) {
									console.error(err.body);
								});
							}
						},
					}
					</script>
				</notices>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
var randomScalingFactor = function() {
        return Math.round(Math.random() * 100);
    };
    var config = {
        type: 'doughnut',
        data: {
			labels: ["정상", "이상반응"],
            datasets: [{
                data: [
                    Store.get("page-initial").total_ae["정상"],
                    Store.get("page-initial").total_ae["이상반응"]
                ],
                backgroundColor: [
                    window.chartColors.yellow,
                    window.chartColors.blue,
                ],
                label: 'Dataset 1'
            }],
        },
        options: {
            responsive: true,
            legend: {
                position: 'top',
            },
            title: {
                display: false,
                text: ''
            },
            animation: {
                animateScale: true,
                animateRotate: true
            },
            cutoutPercentage: 55
        }
    };
    var config2 = {
        type: 'doughnut',
        data: {
			labels: ["실험군", "대조군", "위약군"],
            datasets: [{
                data: [
                    Store.get("page-initial").arm_ae["실험군"],
                    Store.get("page-initial").arm_ae["대조군"],
					Store.get("page-initial").arm_ae["위약군"],
                ],
                backgroundColor: [
                    window.chartColors.yellow,
                    window.chartColors.blue,
					window.chartColors.green,
                ],
                label: 'Dataset 1'
            }],
        },
        options: {
            responsive: true,
            legend: {
                position: 'top',
            },
            title: {
                display: false,
                text: ''
            },
            animation: {
                animateScale: true,
                animateRotate: true
            },
            cutoutPercentage: 55
        }
    };
    var config3 = {
        type: 'bar',
        data: {
				    labels: ["전체", "이상반응", "이행률 저조", "관리필요", "오늘 예약", "중도 탈락"],
				    datasets: [
				        {
				            backgroundColor: [
				                'rgba(255, 99, 132, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(255, 206, 86, 0.2)',
				                'rgba(75, 192, 192, 0.2)',
				                'rgba(153, 102, 255, 0.2)',
				                'rgba(255, 159, 64, 0.2)'
				            ],
				            borderColor: [
				                'rgba(255,99,132,1)',
				                'rgba(54, 162, 235, 1)',
				                'rgba(255, 206, 86, 1)',
				                'rgba(75, 192, 192, 1)',
				                'rgba(153, 102, 255, 1)',
				                'rgba(255, 159, 64, 1)'
				            ],
				            borderWidth: 1,
				            data: [65, 59, 80, 81, 56, 55, 40],
				        }
				    ]
				},
        options: {
            responsive: true,
            legend: {
                display : false
            },
            animation: {
                animateScale: true,
                animateRotate: true
            },
        }
    };
    window.onload = function() {
        var ctx = document.getElementById("chart-area").getContext("2d");
        var ctx2 = document.getElementById("chart-area2").getContext("2d");
        var ctx3 = document.getElementById("bar-chart").getContext("2d");
        window.myDoughnut = new Chart(ctx, config);
        window.myDoughnut = new Chart(ctx2, config2);
        window.myDoughnut = new Chart(ctx3, config3);
    };

    </script>

<% template "bottom.html" . %>
